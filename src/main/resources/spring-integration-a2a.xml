<?xml version="1.0" encoding="UTF-8"?>
<beans:beans
	xmlns:int="http://www.springframework.org/schema/integration"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xmlns:beans="http://www.springframework.org/schema/beans"
	xmlns:util="http://www.springframework.org/schema/util"
	xmlns:int-stream="http://www.springframework.org/schema/integration/stream"
	xmlns:int-http="http://www.springframework.org/schema/integration/http"
	xmlns:int-jms="http://www.springframework.org/schema/integration/jms"
	xsi:schemaLocation="http://www.springframework.org/schema/beans
  http://www.springframework.org/schema/beans/spring-beans.xsd
  http://www.springframework.org/schema/integration
  http://www.springframework.org/schema/integration/spring-integration.xsd
  http://www.springframework.org/schema/integration/stream
  http://www.springframework.org/schema/integration/stream/spring-integration-stream.xsd
  http://www.springframework.org/schema/integration/http
  http://www.springframework.org/schema/integration/http/spring-integration-http.xsd
  http://www.springframework.org/schema/integration/jms
  http://www.springframework.org/schema/integration/jms/spring-integration-jms.xsd
  http://www.springframework.org/schema/util
  http://www.springframework.org/schema/util/spring-util.xsd">


<!-- 
<int:header-enricher input-channel="sending_failed" output-channel="sending_a2a_progress">
	<int:header name="gwStatus" value="SENDING_RT_PROGRESS" overwrite="true"/>
	<int:header name="gwAttemptId" expression="headers.id" overwrite="true"/>
	<int:poller cron="${yucca.a2a.poller.cron}" max-messages-per-poll="${yucca.a2a.poller.maxmessage}">
		
	</int:poller>
</int:header-enricher>
-->

<!-- 
    the poller will process N messages every minute 
    if the size of the group is N (the poll reached the max messages) or 60 seconds time out (poll has less than 100 messages) 
    then the payload with the list of messages is passed to defined output channel
-->

<int:header-enricher input-channel="sending_failed" output-channel="sending_a2a_progress">
	<int:header name="gwStatus" value="SENDING_A2A_PROGRESS" overwrite="true"/>
	<int:poller max-messages-per-poll="3" fixed-rate="10000"/>
</int:header-enricher>


<int:aggregator ref="aggregatorEventForA2A"
	input-channel="sending_a2a_progress" output-channel="sent_a2a"
	discard-channel="logEntryAggrDiscrad"
    send-partial-result-on-expiry="true"
    correlation-strategy="aggregatorEventForA2A"
    group-timeout="10000"
    expire-groups-upon-completion="true"    
    release-strategy-expression="size() == 3">
</int:aggregator>
<!-- usare stream e smartobject -->

<int:channel id="logEntryAggrChannel"/>        
<int:logging-channel-adapter channel="logEntryAggrChannel" logger-name="logEntryAggrChannel" log-full-message="true"></int:logging-channel-adapter>

<int:channel id="logEntryAggrDiscrad"/>        
<int:logging-channel-adapter channel="logEntryAggrDiscrad" logger-name="logEntryAggrDiscrad" log-full-message="true" level="ERROR"></int:logging-channel-adapter>

<!-- the payload is a list o f log entries as result of the aggregator
<int:outbound-channel-adapter channel="logEntryAggrChannel" ref="logEntryPostProcessorReceiver" method="handleMessage"/>
 -->


</beans:beans>